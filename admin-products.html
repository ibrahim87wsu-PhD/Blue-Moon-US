<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product Management - Blue Moon</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Inter,Arial,sans-serif;background:#f5f5f5;color:#333}
    .wrap{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{width:250px;background:#000;color:#fff;padding:20px 0;position:fixed;height:100vh;overflow:auto}
    .sidebar-header{padding:0 20px 20px;border-bottom:1px solid #333;margin-bottom:20px}
    .sidebar-header h2{font-family:"Playfair Display",serif;font-size:1.8rem}
    .sidebar-header span{color:#b8860b}
    .sidebar-nav ul{list-style:none}
    .sidebar-nav a{display:flex;align-items:center;padding:12px 20px;color:#ccc;text-decoration:none;transition:.2s}
    .sidebar-nav a:hover,.sidebar-nav a.active{background:#222;color:#b8860b}
    .sidebar-nav i{width:24px;margin-right:10px}

    /* Main */
    .main{flex:1;margin-left:250px;padding:20px}
    .header{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .header h1{font-family:"Playfair Display",serif}

    .btn{border:none;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .btn-primary{background:#b8860b;color:#fff}
    .btn-secondary{background:#666;color:#fff}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-ghost{background:#eee;color:#333}

    /* Table */
    .card{background:#fff;border-radius:12px;padding:22px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .table-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    .search{position:relative}
    .search input{width:320px;max-width:60vw;border:2px solid #eee;border-radius:10px;padding:10px 12px 10px 38px}
    .search i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#777}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #eee;vertical-align:middle}
    th{background:#fafafa;text-align:left}
    .thumb{width:70px;height:70px;border-radius:10px;object-fit:cover;border:1px solid #eee}
    .muted{color:#777;font-size:.9rem}

    .status{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:.85rem}
    .in{background:#d4edda;color:#155724}
    .low{background:#fff3cd;color:#856404}
    .out{background:#f8d7da;color:#721c24}

    .actions{display:flex;gap:6px}
    .icon-btn{width:38px;height:38px;border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .view{background:#17a2b8;color:#fff}
    .edit{background:#ffc107;color:#000}
    .del{background:#dc3545;color:#fff}

    /* Modal */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;justify-content:center;align-items:center;padding:20px}
    .modal{background:#fff;border-radius:16px;width:100%;max-width:760px;max-height:92vh;overflow:auto;padding:26px}
    .modal h2{font-family:"Playfair Display",serif;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .field{display:flex;flex-direction:column;gap:7px;margin-bottom:12px}
    label{font-weight:600}
    input,select,textarea{border:2px solid #eee;border-radius:12px;padding:12px;font-family:Inter,Arial,sans-serif;font-size:15px}
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#b8860b}

    .images-box{border:2px dashed #ddd;border-radius:14px;padding:14px;background:#fafafa}
    .images-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .images-list{display:flex;flex-direction:column;gap:10px}
    .img-row{display:flex;gap:10px;align-items:center}
    .img-row input{flex:1}
    .mini{width:60px;height:60px;border-radius:12px;object-fit:cover;border:1px solid #e6e6e6;background:#fff}
    .modal-actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}

    /* Auth */
    .auth{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:10000;justify-content:center;align-items:center}
    .auth .box{background:#fff;color:#000;padding:28px;border-radius:16px;text-align:center;max-width:420px}
    .auth a{color:#b8860b;text-decoration:none}

    @media (max-width:860px){
      .sidebar{position:relative;width:100%;height:auto}
      .main{margin-left:0}
      .grid{grid-template-columns:1fr}
      table{display:block;overflow:auto}
    }
  </style>
</head>
<body>
  <!-- Auth -->
  <div class="auth" id="authGate">
    <div class="box">
      <h2>Access Denied</h2>
      <p class="muted" style="margin-top:6px">You must be logged in to access the admin dashboard.</p>
      <p style="margin-top:14px"><a href="admin-login.html">Go to Login</a></p>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal">
      <h2 id="modalTitle">Add New Product</h2>

      <form id="productForm">
        <div class="grid">
          <div class="field">
            <label for="pName">Product Name *</label>
            <input id="pName" required />
          </div>

          <div class="field">
            <label for="pCategory">Category *</label>
            <select id="pCategory" required>
              <option value="">Select Category</option>
              <option value="Women">Women</option>
              <option value="Men">Men</option>
              <option value="Beauty">Beauty</option>
              <option value="Accessories">Accessories</option>
              <option value="New Arrivals">New Arrivals</option>
              <option value="Sale">Sale</option>
            </select>
          </div>

          <div class="field">
            <label for="pPrice">Price ($) *</label>
            <input id="pPrice" type="number" min="0" step="0.01" required />
          </div>

          <div class="field">
            <label for="pCompare">Compare at (optional)</label>
            <input id="pCompare" type="number" min="0" step="0.01" />
          </div>

          <div class="field">
            <label for="pStock">Stock Quantity *</label>
            <input id="pStock" type="number" min="0" required />
          </div>

          <div class="field">
            <label for="pStatus">Status</label>
            <select id="pStatus">
              <option value="In Stock">In Stock</option>
              <option value="Low Stock">Low Stock</option>
              <option value="Out of Stock">Out of Stock</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="pDesc">Description</label>
          <textarea id="pDesc" placeholder="Enter product description..."></textarea>
        </div>

        <!-- MULTI IMAGES -->
        <div class="images-box">
          <div class="images-top">
            <div>
              <strong>Product Images (5â€“6)</strong>
              <div class="muted">Paste image URLs. The first one is the main image.</div>
            </div>
            <button class="btn btn-ghost" type="button" id="addImageBtn">
              <i class="fa-solid fa-plus"></i> Add Image
            </button>
          </div>

          <div class="images-list" id="imagesList"></div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" type="button" id="cancelBtn">
            <i class="fa-solid fa-xmark"></i> Cancel
          </button>
          <button class="btn btn-primary" type="submit">
            <i class="fa-solid fa-floppy-disk"></i> Save Product
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>BLUE<span>MOON</span></h2>
        <p class="muted">Product Management</p>
      </div>

      <nav class="sidebar-nav">
        <ul>
          <li><a href="admin-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="admin-products.html" class="active"><i class="fas fa-box"></i> Products</a></li>
          <li><a href="#"><i class="fas fa-shopping-cart"></i> Orders</a></li>
          <li><a href="#"><i class="fas fa-users"></i> Customers</a></li>
          <li><a href="#"><i class="fas fa-chart-line"></i> Analytics</a></li>
          <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="header">
        <h1>Product Management</h1>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="window.location.href='admin-dashboard.html'">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </button>
          <button class="btn btn-primary" id="openModalBtn">
            <i class="fas fa-plus"></i> Add Product
          </button>
        </div>
      </div>

      <section class="card">
        <div class="table-head">
          <h2 style="margin:0">All Products</h2>
          <div class="search">
            <i class="fas fa-search"></i>
            <input id="searchInput" placeholder="Search products..." />
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Product</th>
              <th>Category</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    // ============================
    // AUTH
    // ============================
    function checkAuth(){
      const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
      if(isLoggedIn !== 'true'){
        document.getElementById('authGate').style.display='flex';
        return false;
      }
      return true;
    }

    // ============================
    // STORAGE KEYS (MUST MATCH SITE PAGES)
    // ============================
    const KEY_PRODUCTS = 'blueMoonProducts';

    // ============================
    // STATE
    // ============================
    let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
    let editingIndex = null;

    // ============================
    // HELPERS
    // ============================
    function money(n){ return `$${Number(n||0).toFixed(2)}`; }

    function statusClass(s){
      if(s === 'Low Stock') return 'low';
      if(s === 'Out of Stock') return 'out';
      return 'in';
    }

    function saveProducts(){
      localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
    }

    function notify(msg){
      const n = document.createElement('div');
      n.textContent = msg;
      n.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#4CAF50;color:#fff;padding:14px 16px;border-radius:10px;z-index:10001;box-shadow:0 8px 20px rgba(0,0,0,.25)';
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 2500);
    }

    // ============================
    // TABLE RENDER
    // ============================
    function renderTable(filter=''){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';

      const q = filter.trim().toLowerCase();
      const list = q ? products.filter(p => JSON.stringify(p).toLowerCase().includes(q)) : products;

      if(list.length === 0){
        tb.innerHTML = `
          <tr>
            <td colspan="7" style="padding:30px;text-align:center">
              <div style="font-size:42px;color:#ddd;margin-bottom:10px"><i class="fa-solid fa-box-open"></i></div>
              <h3 style="margin-bottom:6px">No Products Found</h3>
              <div class="muted">Add your first product to get started.</div>
              <button class="btn btn-primary" style="margin-top:14px" onclick="openModalForCreate()">
                <i class="fa-solid fa-plus"></i> Add Product
              </button>
            </td>
          </tr>
        `;
        return;
      }

      list.forEach((p) => {
        const mainImg = (p.images && p.images.length) ? p.images[0] : (p.image || '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img class="thumb" src="${mainImg || 'https://images.unsplash.com/photo-1445205170230-053b83016050?auto=format&fit=crop&w=200&q=60'}" alt=""></td>
          <td>
            <strong>${p.name}</strong>
            <div class="muted">${p.description ? p.description.slice(0,60) + (p.description.length>60?'...':'') : ''}</div>
          </td>
          <td>${p.category || '-'}</td>
          <td>${money(p.price)} ${p.compareAt ? `<span class="muted" style="margin-left:8px;text-decoration:line-through">${money(p.compareAt)}</span>`:''}</td>
          <td>${Number(p.stock||0)}</td>
          <td><span class="status ${statusClass(p.status)}">${p.status || 'In Stock'}</span></td>
          <td>
            <div class="actions">
              <button class="icon-btn view" title="View" onclick="viewProduct('${p.id}')"><i class="fas fa-eye"></i></button>
              <button class="icon-btn edit" title="Edit" onclick="openModalForEdit('${p.id}')"><i class="fas fa-edit"></i></button>
              <button class="icon-btn del" title="Delete" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    function viewProduct(id){
      const p = products.find(x => String(x.id) === String(id));
      if(!p) return;
      alert(
        `Product Details:\n\n` +
        `Name: ${p.name}\n` +
        `Category: ${p.category}\n` +
        `Price: ${money(p.price)}\n` +
        (p.compareAt ? `Compare At: ${money(p.compareAt)}\n` : '') +
        `Stock: ${p.stock}\n` +
        `Status: ${p.status}\n` +
        `Images: ${(p.images||[]).length}\n\n` +
        (p.description ? `Description:\n${p.description}` : '')
      );
    }

    function deleteProduct(id){
      if(!confirm('Delete this product?')) return;
      products = products.filter(p => String(p.id) !== String(id));
      saveProducts();
      renderTable(document.getElementById('searchInput').value);
      notify('Product deleted!');
    }

    // ============================
    // MODAL + MULTI IMAGES UI
    // ============================
    const overlay = document.getElementById('modalOverlay');
    const form = document.getElementById('productForm');
    const imagesList = document.getElementById('imagesList');

    function openOverlay(){
      overlay.style.display='flex';
      overlay.setAttribute('aria-hidden','false');
    }
    function closeOverlay(){
      overlay.style.display='none';
      overlay.setAttribute('aria-hidden','true');
      editingIndex = null;
    }

    function createImageRow(value=''){
      const row = document.createElement('div');
      row.className = 'img-row';
      row.innerHTML = `
        <img class="mini" alt="preview">
        <input type="url" placeholder="https://example.com/image.jpg" value="${value.replace(/"/g,'&quot;')}">
        <button type="button" class="btn btn-danger" style="padding:10px 12px;border-radius:10px">
          <i class="fa-solid fa-trash"></i>
        </button>
      `;

      const img = row.querySelector('img');
      const input = row.querySelector('input');
      const del = row.querySelector('button');

      function updatePreview(){
        const url = input.value.trim();
        if(!url){
          img.removeAttribute('src');
          img.style.background = '#fff';
          return;
        }
        img.src = url;
        img.onerror = () => { img.removeAttribute('src'); };
      }

      input.addEventListener('input', updatePreview);
      del.addEventListener('click', () => row.remove());
      updatePreview();
      return row;
    }

    function setImagesRows(urls){
      imagesList.innerHTML='';
      const list = (urls && urls.length) ? urls : ['','','','','']; // default 5 slots
      list.slice(0,6).forEach(u => imagesList.appendChild(createImageRow(u || '')));
    }

    function getImagesFromRows(){
      const urls = Array.from(imagesList.querySelectorAll('input'))
        .map(i => i.value.trim())
        .filter(Boolean);
      return urls.slice(0,6);
    }

    function openModalForCreate(){
      document.getElementById('modalTitle').textContent = 'Add New Product';
      editingIndex = null;

      form.reset();
      setImagesRows(['','','','','']); // 5 empty
      openOverlay();
    }

    function openModalForEdit(id){
      const idx = products.findIndex(p => String(p.id) === String(id));
      if(idx === -1) return;
      editingIndex = idx;
      const p = products[idx];

      document.getElementById('modalTitle').textContent = 'Edit Product';
      document.getElementById('pName').value = p.name || '';
      document.getElementById('pCategory').value = p.category || '';
      document.getElementById('pPrice').value = p.price ?? '';
      document.getElementById('pCompare').value = p.compareAt ?? '';
      document.getElementById('pStock').value = p.stock ?? 0;
      document.getElementById('pStatus').value = p.status || 'In Stock';
      document.getElementById('pDesc').value = p.description || '';
      setImagesRows(p.images || []);
      openOverlay();
    }

    // Buttons
    document.getElementById('openModalBtn').addEventListener('click', openModalForCreate);
    document.getElementById('cancelBtn').addEventListener('click', closeOverlay);
    document.getElementById('addImageBtn').addEventListener('click', () => {
      if(imagesList.querySelectorAll('.img-row').length >= 6){
        alert('Maximum 6 images per product.');
        return;
      }
      imagesList.appendChild(createImageRow(''));
    });

    // Save
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const images = getImagesFromRows();
      if(images.length === 0){
        alert('Please add at least 1 image URL (main image).');
        return;
      }

      const product = {
        id: editingIndex !== null ? products[editingIndex].id : Date.now(),
        name: document.getElementById('pName').value.trim(),
        category: document.getElementById('pCategory').value,
        price: Number(document.getElementById('pPrice').value),
        compareAt: document.getElementById('pCompare').value ? Number(document.getElementById('pCompare').value) : null,
        stock: Number(document.getElementById('pStock').value),
        status: document.getElementById('pStatus').value,
        description: document.getElementById('pDesc').value.trim(),
        images,
        date: new Date().toISOString()
      };

      if(!product.name || !product.category || isNaN(product.price)){
        alert('Please fill required fields.');
        return;
      }

      if(editingIndex !== null){
        products[editingIndex] = product;
        notify('Product updated!');
      } else {
        products.unshift(product);
        notify('Product added!');
      }

      saveProducts();
      closeOverlay();
      renderTable(document.getElementById('searchInput').value);
    });

    // Close modal on overlay click
    overlay.addEventListener('click', (e) => {
      if(e.target === overlay) closeOverlay();
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', function(){
      renderTable(this.value);
    });

    // ============================
    // INIT
    // ============================
    document.addEventListener('DOMContentLoaded', () => {
      if(!checkAuth()) return;

      // If empty, seed 1 demo product with multiple images
      if(products.length === 0){
        products = [{
          id: 1001,
          name: "Blue Moon Luxury Black Shoulder Bag",
          category: "Women",
          price: 220,
          compareAt: 280,
          stock: 12,
          status: "In Stock",
          description: "Premium shoulder bag with smooth leather finish and elegant hardware.",
          images: [
            "https://images.unsplash.com/photo-1548036328-c9fa89d128fa?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1584917865442-de89df76afd3?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1590874103328-eac38a683ce7?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?auto=format&fit=crop&w=1200&q=80"
          ],
          date: new Date().toISOString()
        }];
        saveProducts();
      }

      renderTable();
      setImagesRows(['','','','','']); // ready for create modal
    });
  </script>
</body>
</html>
